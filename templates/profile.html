{% extends 'base.html' %}

{% block title %} Country Profile {% endblock %}

{% block css %} 

#content {
    display: inline-block;
    margin-left: 50px;
}

#divline {
    margin-right: 100px;
}

.axis path,
.axis line {
    fill: none;
    stroke: black;
    shape-rendering: crispEdges;
}

.axis text {
    font-family: sans-serif;
    font-size: 11px;
}

.container {
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 370px;
    height: 100%;
    max-height: 350px;
    position: absolute;
    margin-left: 825px;
    border: 1px solid orange;
    justify-content: space-around;
    padding-left: 10px;
}

#wrapper1 {
    margin-top: 30px;
}

#wrapper2 {
    margin-top: 20px;
}

.news1 {
    overflow: auto;
}

.news2 {
    overflow: auto;
}


{% endblock %}

{% block head %}
<script src='http://d3js.org/d3.v3.min.js'></script> 
{% endblock %}


{% block content %}


    {% for country in recent_metrics %}

    <div id="content">
    
    <h1> {{ country }} </h1>

        {% for m in recent_metrics[country] %}

            {% if recent_metrics[country][m][1] %}

                <li> {{ m }} : {{ recent_metrics[country][m][1] }} ({{ recent_metrics[country][m][0] }}) </li>

            {% else %}
                <li> {{ m }} : No Data Available </li>

            {% endif %}

        {% endfor %}

    </div>

    {% endfor %}

<br><br>
<a href="/metrics">About these metrics </a>
<br> <br>
<h3> Polity Time Series </h3>

<div id="divline">
<canvas id="lineChart" width="425" height="125"></canvas>
</div>

<script>
//polity time series comparison chart
Chart.defaults.global.responsive = true;
var options = {
      scales : {
        xAxes : [ {
            gridLines : {
                display : false
            }
        } ],
        yAxes : [ {
            gridLines : {
                display : true
            }
        }]
    }
    };

var ctx = $("#lineChart").get(0).getContext("2d");

$.get("/polity-scores.json", function (data) {
    var polityLineChart = new Chart.Line(ctx, {data: data, options: options});
});

</script>

<h3>GDP Time Series</h3>
<p>Color of the circles indicate the country's polity score for that year. Ranges from red(most authoritarian) to blue(most democratic). Purple indicates a score of 0 and yellow indicates no score. </p>


<div id="block1">
    <div class="container" id="wrapper1">
        <div class="news1">
            <p>Select a circle to see search results for that year.</p>
        </div>
    </div>
</div>


<div id="block2">
    <div class="container" id="wrapper2">
        <div class="news2">
            <p>Select a circle to see search results for that year.</p>
        </div>
    </div>
</div>


<script>
//point is an array like [x, y, color, index] of the data point the user clicked, this comes from the d param in the d3 event handler function.
function createNews(point, o) {
    //index of 1 is the first country, index of 2 is the second country
    var index = point[3];

    var params = {
        'year': point[0],
        'country_index': index
    };

    //blocker to limit api requests
    // if (params['year'] !== '2015') {
    //         console.log('blocked');
    //         return;
    //     }
  
    $.post('/news', params, function(results) {
        //if o is swapped, meaning the graphs are in reverse order, swap the index accordingly otherwise the search results will be shown in the wrong box
        if (o == 'swapped' && index == 1) {
            index = 2;
        } else if (o == 'swapped' && index == 2) {
            index = 1;
        }

        if (!jQuery.isEmptyObject(results)) {
          $(".news" + String(index)).empty();
          $(".news" + String(index)).append("<p>" + results['tagline'] + "</p>");

          for (var r in results) {
            var content = "<div class='item'> <li> <a href=" + results[r]['url'] + "target='_blank'>" + results[r]['title'] + " </a> </li>"  + "<p>" + results[r]['snippet'] + "</p> </div>";
            //this if stmt is necessary b/c of the tagline prop which doesn't have the above props and thus shows undef
            if (results[r]['title']) {
                $(".news" + String(index)).append(content);
            }
          }
        } else {
            //console.log('test');
            $(".news" + String(index)).append("<div> <p> Search results not available for this year </p> </div>");
        }
    });

}

function deleteSearchBox(n) {
    $('#wrapper' + String(n)).remove();
}


  d3.json('/gdp.json', function makeScatter(gdp_data) {
    //ref will be used to delete the relevant search box when there is no graph and indicate which div to append to
    var ref = 0;
    //to account for cases where the 2nd country's graph is shown first, so search results end up in the correct box
    var orient;  

    for (var country in gdp_data) {
        ref++;
        //title of the graph
        d3.select("#block" + String(ref)).append("p").text(country + " : GDP per capita by year")
                                                     .attr("class", "label");

        if (gdp_data[country].length <= 1) {
            d3.select("#block" + String(ref)).append("p").text("No data available for this country");
            deleteSearchBox(ref);
            orient = 'aligned';
        } else {
            var w = 800;
            var h = 400;
            var padding = 50;
            var dataset = gdp_data[country];

            //check if graph order is swapped and note it if it is. dataset[0][3] should be 2 on the 2nd iter. 
            if (ref == 2 && dataset[0][3] !== 2 && !orient) {
                orient = 'swapped';
            }

            var svg = d3.select("#block" + String(ref)).append("svg")
                        .attr("width", w)
                        .attr("height", h)
                        .attr("class", "graph" + String(ref));

            //scales for x axis, y axis and circle size. .range scales the domain data to a specified scale
            var xScale = d3.scale.linear()
                                 .domain([d3.min(dataset, function(d) { return d[0]; }), d3.max(dataset, function(d) { return d[0]; })])
                                 .range([padding, w - padding]);
            var yScale = d3.scale.linear()
                                 .domain([d3.min(dataset, function(d) { return d[1]; }), d3.max(dataset, function(d) { return d[1]; })])
                                 .range([h - padding, padding]);
            var rScale = d3.scale.linear()
                                 .domain([2, 5]);

            var color = d3.scale.ordinal()
                                .domain([-10, -9, -8, -7, -6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 999])
                                .range(["rgba(165, 0, 33, 1.0)", "rgba(165, 0, 33, 1.0)", "rgba(216, 38, 50, 1.0)", "rgba(216, 38, 50, 1.0)", "rgba(247, 109, 94, 1.0)", "rgba(247, 109, 94, 1.0)", "rgba(243, 171, 159, 1.0)", "rgba(243, 171, 159, 1.0)", "rgba(244, 214, 209, 1.0)", "rgba(244, 214, 209, 1.0)", "rgba(219, 190, 248, 1.0)", "rgba(192, 235, 251, 1.0)", "rgba(192, 235, 251, 1.0)", "rgba(114, 217, 255, 1.0)", "rgba(114, 217, 255, 1.0)", "rgba(63, 160, 255, 1.0)", "rgba(63, 160, 255, 1.0)", "rgba(38, 77, 245, 1.0)", "rgba(38, 77, 245, 1.0)", "rgba(41, 10, 216, 1.0)", "rgba(41, 10, 216, 1.0)", "rgba(235, 236, 161, 1.0)"]);

            //create x and y axis and .format() on xAxis to get rid of the commas in years
            var xAxis = d3.svg.axis()
                              .scale(xScale)
                              .orient("bottom").ticks(15)
                              .tickFormat(d3.format("d"));
            var yAxis = d3.svg.axis()
                              .scale(yScale)
                              .orient("left").ticks(15);

            //creating the circles
            //for event handler funct, d is the data like [x, y, color, c_index]
            svg.selectAll("circle")
                .data(dataset)
                .enter()
                .append("circle")
                .attr("cx", function(d) { return xScale(d[0]); })
                .attr("cy", function(d) { return yScale(d[1]); })
                .attr("r", function(d) { return 4; })
                .style('fill', function(d) { return color(d[2]); } )
                .on('click', function(d, i) {
                    createNews(d, orient); 
                });

            //creating the axes
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0," + (h - padding) + ")")
                .call(xAxis);

            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(" + padding + ",0)")
                .call(yAxis);
        //end else stmt
        }
    //ending for in loop
    }
  //end of makeScatter funct
  })

</script>


{% endblock %}

